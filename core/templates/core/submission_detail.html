{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Submission Detail - Scavenger Hunt</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/core.css' %}">
    <link rel="icon" href="{% static 'img/favicon.png' %}" type="image/png">
    <style>
        .detail-layout {
            display: grid;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .detail-section {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .detail-section__header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .detail-section__header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: rgba(37, 99, 235, 0.1);
            transition: background 0.15s;
        }

        .back-link:hover {
            background: rgba(37, 99, 235, 0.2);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-item__label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-item__value {
            font-size: 1rem;
            color: var(--text);
        }

        .detail-item__value--large {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .detail-item__value a {
            color: var(--accent);
            text-decoration: none;
        }

        .detail-item__value a:hover {
            text-decoration: underline;
        }

        .answer-box {
            background: var(--background);
            border-radius: 12px;
            padding: 1.25rem;
            font-family: monospace;
            font-size: 1rem;
            word-break: break-all;
            white-space: pre-wrap;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge--first-blood {
            background: rgba(239, 68, 68, 0.15);
            color: rgb(185, 28, 28);
        }

        .badge--success {
            background: rgba(16, 185, 129, 0.15);
            color: rgb(5, 122, 85);
        }

        .related-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .related-table th,
        .related-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .related-table th {
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .related-table tr:hover {
            background: var(--background);
        }

        .related-table a {
            color: var(--accent);
            text-decoration: none;
        }

        .related-table a:hover {
            text-decoration: underline;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body class="layout" data-participant-id="{{ participant.pk }}" data-is-admin="{{ participant.is_admin|yesno:'true,false' }}">
    <div class="toast-container" data-toast-container aria-live="polite" aria-atomic="true"{% if not messages %} hidden{% endif %}>
        {% if messages %}
            {% for message in messages %}
                <div class="toast toast--{{ message.tags|default:'info' }}" data-toast>
                    <div class="toast__content">{{ message }}</div>
                    <button type="button" class="toast__close" data-toast-close aria-label="Dismiss notification">&times;</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>
    <div class="page page--challenge">
        {% if ENABLE_SNOW_OVERLAY %}
        <div class="snow-overlay" aria-hidden="true"></div>
        {% endif %}
        <header class="site-nav">
            <div class="site-nav__inner">
            <div class="site-nav__left">
                <div class="logo" aria-hidden="true">
                    <img src="{% static 'img/favicon.png' %}" alt="" class="logo__image">
                </div>
                <div class="site-nav__title">
                    <span class="title-main">Scavenger Hunt</span>
                    <span class="title-sub">{{ HUNT_YEAR }}</span>
                </div>
            </div>
            <div class="site-nav__center">
                <span class="countdown countdown--inactive">Submission Detail</span>
            </div>
            <div class="site-nav__right">
                <button id="theme-toggle" class="icon-button" type="button" aria-label="Toggle theme">
                    <span class="icon-button__icon" data-theme-icon aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="4.5"></circle>
                            <path d="M12 2v2"></path>
                            <path d="M12 20v2"></path>
                            <path d="M4.93 4.93l1.42 1.42"></path>
                            <path d="M17.66 17.66l1.41 1.41"></path>
                            <path d="M2 12h2"></path>
                            <path d="M20 12h2"></path>
                            <path d="M4.93 19.07l1.42-1.42"></path>
                            <path d="M17.66 6.34l1.41-1.41"></path>
                        </svg>
                    </span>
                </button>
                <div class="profile-menu">
                    <button class="profile-menu__trigger" type="button" aria-haspopup="true" aria-expanded="false">
                        <span class="profile-menu__avatar">{{ participant.display_name|first|default:participant.ion_username|first|upper }}</span>
                        <span class="profile-menu__label">{{ participant.display_name|default:participant.ion_username }}</span>
                    </button>
                    <div class="profile-menu__popover" role="menu">
                        <p class="profile-menu__hint">Signed in as <strong>{{ participant.display_name|default:participant.ion_username }}</strong></p>
                        <div class="profile-menu__actions">
                            <a href="{% url 'core:challenge' %}" class="profile-menu__button">Challenge Board</a>
                            {% if participant.is_admin %}
                                <a href="{% url 'core:analytics' %}" class="profile-menu__button">Analytics</a>
                                <a href="{% url 'admin:index' %}" class="profile-menu__button">Admin dashboard</a>
                            {% endif %}
                            <form method="post" action="{% url 'core:logout' %}" class="profile-menu__logout">
                                {% csrf_token %}
                                <button type="submit" class="profile-menu__button">Log out</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </header>

        <main class="detail-layout">
            <section class="detail-section">
                <div class="detail-section__header">
                    <div>
                        <h2>
                            Submission #{{ solve.id }}
                            {% if is_first_blood %}<span class="badge badge--first-blood">ü©∏ First Blood</span>{% endif %}
                        </h2>
                    </div>
                    <a href="{% url 'core:analytics' %}" class="back-link">‚Üê Back to Analytics</a>
                </div>

                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-item__label">Challenge</span>
                        <span class="detail-item__value">
                            <a href="{% url 'core:challenge_detail' solve.challenge.slug %}">{{ solve.challenge.title }}</a>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item__label">Category</span>
                        <span class="detail-item__value">{{ solve.challenge.category.name }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item__label">Challenge Type</span>
                        <span class="detail-item__value">{{ solve.challenge.get_challenge_type_display }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item__label">Points Awarded</span>
                        <span class="detail-item__value detail-item__value--large">{{ solve.awarded_points }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item__label">Submitted By</span>
                        <span class="detail-item__value">
                            <a href="{% url 'core:user_detail' solve.participant.ion_username %}">{{ solve.participant.display_name|default:solve.participant.ion_username }}</a>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item__label">Ion Username</span>
                        <span class="detail-item__value">{{ solve.participant.ion_username }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item__label">Team</span>
                        <span class="detail-item__value">Class of {{ solve.team_year }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item__label">Submission Time</span>
                        <span class="detail-item__value">{{ solve_time|date:"F j, Y, g:i:s A" }} ET</span>
                    </div>
                </div>
            </section>

            <section class="detail-section">
                <h3 class="section-title">Submitted Answer</h3>
                <div class="answer-box">{{ solve.submitted_answer }}</div>
            </section>

            {% if other_solves %}
            <section class="detail-section">
                <h3 class="section-title">Other Solves for This Challenge</h3>
                <table class="related-table">
                    <thead>
                        <tr>
                            <th>Team</th>
                            <th>Submitted By</th>
                            <th>Points</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for other in other_solves %}
                        <tr>
                            <td>Class of {{ other.team_year }}</td>
                            <td><a href="{% url 'core:user_detail' other.participant.ion_username %}">{{ other.participant.display_name|default:other.participant.ion_username }}</a></td>
                            <td>{{ other.awarded_points }}</td>
                            <td><a href="{% url 'core:submission_detail' other.id %}">{{ other.created_at|date:"M j, g:i A" }}</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
            {% endif %}

            {% if participant_other_solves %}
            <section class="detail-section">
                <h3 class="section-title">Other Solves by {{ solve.participant.display_name|default:solve.participant.ion_username }}</h3>
                <table class="related-table">
                    <thead>
                        <tr>
                            <th>Challenge</th>
                            <th>Category</th>
                            <th>Points</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for other in participant_other_solves %}
                        <tr>
                            <td><a href="{% url 'core:challenge_detail' other.challenge.slug %}">{{ other.challenge.title }}</a></td>
                            <td>{{ other.challenge.category.name }}</td>
                            <td>{{ other.awarded_points }}</td>
                            <td><a href="{% url 'core:submission_detail' other.id %}">{{ other.created_at|date:"M j, g:i A" }}</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <p style="margin-top: 1rem; text-align: center;">
                    <a href="{% url 'core:user_detail' solve.participant.ion_username %}" style="color: var(--accent);">View all activity for this user ‚Üí</a>
                </p>
            </section>
            {% endif %}
        </main>

        <footer class="footer">
            <p>&copy; {% now "Y" %} SCAV {{ HUNT_YEAR }} ¬∑ Crafted by students for students</p>
        </footer>
    </div>

    <script>
    (function () {
        const STORAGE_KEY = "scav-theme";
        const body = document.body;

        const THEME_ICONS = {
            light: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4.5"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="M4.93 4.93l1.42 1.42"></path><path d="M17.66 17.66l1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="M4.93 19.07l1.42-1.42"></path><path d="M17.66 6.34l1.41-1.41"></path></svg>`,
            dark: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79Z"></path></svg>`
        };

        function applyTheme(theme) {
            body.dataset.theme = theme;
            const icon = document.querySelector('[data-theme-icon]');
            if (icon) {
                icon.innerHTML = theme === 'dark' ? THEME_ICONS.dark : THEME_ICONS.light;
            }
        }

        {% if ENABLE_SNOW_OVERLAY %}
        const SNOWFLAKE_COUNT = 80;
        const snowOverlay = document.querySelector('.snow-overlay');
        if (snowOverlay) {
            for (let index = 0; index < SNOWFLAKE_COUNT; index += 1) {
                const flake = document.createElement('span');
                flake.className = 'snowflake';
                const size = (Math.random() * 4) + 2;
                const duration = (Math.random() * 8) + 8;
                const delay = Math.random() * 8;
                const opacity = Math.random() * 0.5 + 0.4;
                const drift = (Math.random() * 2 - 1) * 4;
                const xPosition = Math.random() * 100;
                flake.style.setProperty('--size', `${size}px`);
                flake.style.setProperty('--duration', `${duration}s`);
                flake.style.setProperty('--delay', `${delay}s`);
                flake.style.setProperty('--opacity', opacity.toFixed(2));
                flake.style.setProperty('--drift', `${drift.toFixed(2)}rem`);
                flake.style.setProperty('--x-position', `${xPosition.toFixed(2)}%`);
                snowOverlay.appendChild(flake);
            }
        }
        {% endif %}

        const savedTheme = localStorage.getItem(STORAGE_KEY);
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }

        const toggle = document.getElementById('theme-toggle');
        if (toggle) {
            toggle.addEventListener('click', () => {
                const next = body.dataset.theme === 'dark' ? 'light' : 'dark';
                applyTheme(next);
                localStorage.setItem(STORAGE_KEY, next);
            });
        }

        // Profile menu
        const profileTrigger = document.querySelector('.profile-menu__trigger');
        const profilePopover = document.querySelector('.profile-menu__popover');
        if (profileTrigger && profilePopover) {
            profileTrigger.addEventListener('click', () => {
                const expanded = profileTrigger.getAttribute('aria-expanded') === 'true';
                profileTrigger.setAttribute('aria-expanded', String(!expanded));
                profilePopover.toggleAttribute('data-open');
            });

            document.addEventListener('click', (event) => {
                if (!profilePopover.contains(event.target) && !profileTrigger.contains(event.target)) {
                    profileTrigger.setAttribute('aria-expanded', 'false');
                    profilePopover.removeAttribute('data-open');
                }
            });
        }

        // Toast handling
        const toastContainer = document.querySelector('[data-toast-container]');
        if (toastContainer) {
            const dismissToast = (toast, delay = 0) => {
                if (!toast) return;
                window.setTimeout(() => {
                    toast.classList.add('toast--closing');
                    window.setTimeout(() => {
                        toast.remove();
                        if (!toastContainer.querySelector('[data-toast]')) {
                            toastContainer.hidden = true;
                        }
                    }, 200);
                }, delay);
            };

            toastContainer.querySelectorAll('[data-toast]').forEach((toast, index) => {
                dismissToast(toast, 3500 + index * 500);
                const closeButton = toast.querySelector('[data-toast-close]');
                if (closeButton) {
                    closeButton.addEventListener('click', () => dismissToast(toast));
                }
            });
        }
    })();
    </script>
</body>
</html>
