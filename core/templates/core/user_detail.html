{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ target_user.display_name|default:target_user.ion_username }} - User Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/core.css' %}">
    <link rel="icon" href="{% static 'img/favicon.png' %}" type="image/png">
    <style>
        .detail-layout {
            display: grid;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .detail-section {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .detail-section__header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .detail-section__header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: rgba(37, 99, 235, 0.1);
            transition: background 0.15s;
        }

        .back-link:hover {
            background: rgba(37, 99, 235, 0.2);
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
        }

        .user-info h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }

        .user-info p {
            color: var(--text-muted);
            margin: 0.25rem 0 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: var(--background);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-card__value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-card__label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .breakdown-card {
            background: var(--background);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .breakdown-card__title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1rem;
        }

        .breakdown-list {
            list-style: none;
        }

        .breakdown-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .breakdown-list li:last-child {
            border-bottom: none;
        }

        .breakdown-name {
            color: var(--text);
        }

        .breakdown-value {
            color: var(--text-muted);
            font-weight: 500;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge--first-blood {
            background: rgba(239, 68, 68, 0.15);
            color: rgb(185, 28, 28);
        }

        .badge--admin {
            background: rgba(139, 92, 246, 0.15);
            color: rgb(109, 40, 217);
        }

        .badge--scavcomm {
            background: rgba(16, 185, 129, 0.15);
            color: rgb(5, 122, 85);
        }

        .badge--team {
            background: rgba(37, 99, 235, 0.15);
            color: var(--accent);
        }

        .solves-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .solves-table th,
        .solves-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .solves-table th {
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .solves-table tr:hover {
            background: var(--background);
        }

        .solves-table a {
            color: var(--accent);
            text-decoration: none;
        }

        .solves-table a:hover {
            text-decoration: underline;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .first-blood-list {
            display: grid;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .first-blood-item {
            background: var(--background);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .first-blood-item a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }

        .first-blood-item a:hover {
            text-decoration: underline;
        }

        .first-blood-points {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .contribution-bar {
            background: var(--border);
            border-radius: 999px;
            height: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .contribution-bar__fill {
            background: var(--accent);
            height: 100%;
            border-radius: 999px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="layout" data-participant-id="{{ participant.pk }}" data-is-admin="{{ participant.is_admin|yesno:'true,false' }}">
    <div class="toast-container" data-toast-container aria-live="polite" aria-atomic="true"{% if not messages %} hidden{% endif %}>
        {% if messages %}
            {% for message in messages %}
                <div class="toast toast--{{ message.tags|default:'info' }}" data-toast>
                    <div class="toast__content">{{ message }}</div>
                    <button type="button" class="toast__close" data-toast-close aria-label="Dismiss notification">&times;</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>
    <div class="page page--challenge">
        {% if ENABLE_SNOW_OVERLAY %}
        <div class="snow-overlay" aria-hidden="true"></div>
        {% endif %}
        <header class="site-nav">
            <div class="site-nav__inner">
            <div class="site-nav__left">
                <div class="logo" aria-hidden="true">
                    <img src="{% static 'img/favicon.png' %}" alt="" class="logo__image">
                </div>
                <div class="site-nav__title">
                    <span class="title-main">Scavenger Hunt</span>
                    <span class="title-sub">{{ HUNT_YEAR }}</span>
                </div>
            </div>
            <div class="site-nav__center">
                <span class="countdown countdown--inactive">User Analytics</span>
            </div>
            <div class="site-nav__right">
                <button id="theme-toggle" class="icon-button" type="button" aria-label="Toggle theme">
                    <span class="icon-button__icon" data-theme-icon aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="4.5"></circle>
                            <path d="M12 2v2"></path>
                            <path d="M12 20v2"></path>
                            <path d="M4.93 4.93l1.42 1.42"></path>
                            <path d="M17.66 17.66l1.41 1.41"></path>
                            <path d="M2 12h2"></path>
                            <path d="M20 12h2"></path>
                            <path d="M4.93 19.07l1.42-1.42"></path>
                            <path d="M17.66 6.34l1.41-1.41"></path>
                        </svg>
                    </span>
                </button>
                <div class="profile-menu">
                    <button class="profile-menu__trigger" type="button" aria-haspopup="true" aria-expanded="false">
                        <span class="profile-menu__avatar">{{ participant.display_name|first|default:participant.ion_username|first|upper }}</span>
                        <span class="profile-menu__label">{{ participant.display_name|default:participant.ion_username }}</span>
                    </button>
                    <div class="profile-menu__popover" role="menu">
                        <p class="profile-menu__hint">Signed in as <strong>{{ participant.display_name|default:participant.ion_username }}</strong></p>
                        <div class="profile-menu__actions">
                            <a href="{% url 'core:challenge' %}" class="profile-menu__button">Challenge Board</a>
                            {% if participant.is_admin or participant.is_scavcomm %}
                                <a href="{% url 'core:analytics' %}" class="profile-menu__button">Analytics</a>
                            {% endif %}
                            {% if participant.is_admin %}
                                <a href="{% url 'admin:index' %}" class="profile-menu__button">Admin dashboard</a>
                            {% endif %}
                            <form method="post" action="{% url 'core:logout' %}" class="profile-menu__logout">
                                {% csrf_token %}
                                <button type="submit" class="profile-menu__button">Log out</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </header>

        <main class="detail-layout">
            <!-- User Profile Header -->
            <section class="detail-section">
                <div class="detail-section__header">
                    <div class="user-header">
                        <div class="user-avatar">{{ target_user.display_name|first|default:target_user.ion_username|first|upper }}</div>
                        <div class="user-info">
                            <h2>
                                {{ target_user.display_name|default:target_user.ion_username }}
                                {% if target_user.is_admin %}<span class="badge badge--admin">Admin</span>{% endif %}
                                {% if target_user.is_scavcomm %}<span class="badge badge--scavcomm">Scavcomm</span>{% endif %}
                            </h2>
                            <p>@{{ target_user.ion_username }} ¬∑ {{ target_user.email|default:"No email" }}</p>
                            {% if is_valid_team %}
                                <p style="margin-top: 0.5rem;">
                                    <span class="badge badge--team">Class of {{ team_year }}</span>
                                    {% if team_rank %} ¬∑ Rank #{{ team_rank }}{% endif %}
                                </p>
                            {% else %}
                                <p style="margin-top: 0.5rem; color: var(--text-muted);">No team assigned</p>
                            {% endif %}
                        </div>
                    </div>
                    <a href="{% url 'core:analytics' %}" class="back-link">‚Üê Back to Analytics</a>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card__value">{{ total_points }}</div>
                        <div class="stat-card__label">Total Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__value">{{ total_solves }}</div>
                        <div class="stat-card__label">Challenges Solved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__value">{{ first_bloods|length }}</div>
                        <div class="stat-card__label">First Bloods</div>
                    </div>
                    {% if is_valid_team %}
                    <div class="stat-card">
                        <div class="stat-card__value">{{ contribution_percent }}%</div>
                        <div class="stat-card__label">Team Contribution</div>
                    </div>
                    {% endif %}
                </div>

                {% if is_valid_team and team_total_points > 0 %}
                <div style="margin-top: 1.5rem;">
                    <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                        Contribution to Class of {{ team_year }} ({{ total_points }} / {{ team_total_points }} pts)
                    </p>
                    <div class="contribution-bar">
                        <div class="contribution-bar__fill" style="width: {{ contribution_percent }}%;"></div>
                    </div>
                </div>
                {% endif %}
            </section>

            <!-- First Bloods -->
            {% if first_bloods %}
            <section class="detail-section">
                <h3 class="section-title">ü©∏ First Bloods ({{ first_bloods|length }})</h3>
                <div class="first-blood-list">
                    {% for solve in first_bloods %}
                    <div class="first-blood-item">
                        <a href="{% url 'core:challenge_detail' solve.challenge.slug %}">{{ solve.challenge.title }}</a>
                        <span class="first-blood-points">{{ solve.awarded_points }} pts ¬∑ {{ solve.created_at|date:"M j, g:i A" }}</span>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Breakdown Stats -->
            <section class="detail-section">
                <h3 class="section-title">Performance Breakdown</h3>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <h4 class="breakdown-card__title">By Category</h4>
                        {% if category_stats %}
                        <ul class="breakdown-list">
                            {% for cat in category_stats %}
                            <li>
                                <span class="breakdown-name">{{ cat.challenge__category__name }}</span>
                                <span class="breakdown-value">{{ cat.solve_count }} solve{{ cat.solve_count|pluralize }} ¬∑ {{ cat.points }} pts</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="empty-state">No solves yet</p>
                        {% endif %}
                    </div>
                    <div class="breakdown-card">
                        <h4 class="breakdown-card__title">By Challenge Type</h4>
                        {% if type_stats %}
                        <ul class="breakdown-list">
                            {% for typ in type_stats %}
                            <li>
                                <span class="breakdown-name">{{ typ.challenge__challenge_type|title }}</span>
                                <span class="breakdown-value">{{ typ.solve_count }} solve{{ typ.solve_count|pluralize }} ¬∑ {{ typ.points }} pts</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="empty-state">No solves yet</p>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- All Solves -->
            <section class="detail-section">
                <h3 class="section-title">All Solves ({{ total_solves }})</h3>
                {% if user_solves %}
                <table class="solves-table">
                    <thead>
                        <tr>
                            <th>Challenge</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Points</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for solve in user_solves %}
                        <tr>
                            <td><a href="{% url 'core:challenge_detail' solve.challenge.slug %}">{{ solve.challenge.title }}</a></td>
                            <td>{{ solve.challenge.category.name }}</td>
                            <td>{{ solve.challenge.get_challenge_type_display }}</td>
                            <td>{{ solve.awarded_points }}</td>
                            <td><a href="{% url 'core:submission_detail' solve.id %}">{{ solve.created_at|date:"M j, g:i A" }}</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p>This user hasn't solved any challenges yet.</p>
                </div>
                {% endif %}
            </section>

            <!-- Account Info -->
            <section class="detail-section">
                <h3 class="section-title">Account Information</h3>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <ul class="breakdown-list">
                            <li>
                                <span class="breakdown-name">Ion Username</span>
                                <span class="breakdown-value">{{ target_user.ion_username }}</span>
                            </li>
                            <li>
                                <span class="breakdown-name">Display Name</span>
                                <span class="breakdown-value">{{ target_user.display_name|default:"Not set" }}</span>
                            </li>
                            <li>
                                <span class="breakdown-name">Email</span>
                                <span class="breakdown-value">{{ target_user.email|default:"Not set" }}</span>
                            </li>
                            <li>
                                <span class="breakdown-name">Graduation Year</span>
                                <span class="breakdown-value">{{ target_user.graduation_year|default:"Not set" }}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="breakdown-card">
                        <ul class="breakdown-list">
                            <li>
                                <span class="breakdown-name">Admin Status</span>
                                <span class="breakdown-value">{% if target_user.is_admin %}Yes{% else %}No{% endif %}</span>
                            </li>
                            <li>
                                <span class="breakdown-name">Scavcomm Status</span>
                                <span class="breakdown-value">{% if target_user.is_scavcomm %}Yes{% else %}No{% endif %}</span>
                            </li>
                            <li>
                                <span class="breakdown-name">Last Login</span>
                                <span class="breakdown-value">{{ target_user.last_login|date:"M j, Y g:i A"|default:"Never" }}</span>
                            </li>
                            <li>
                                <span class="breakdown-name">Account Created</span>
                                <span class="breakdown-value">{{ target_user.created_at|date:"M j, Y g:i A" }}</span>
                            </li>
                            <li>
                                <span class="breakdown-name">Last Updated</span>
                                <span class="breakdown-value">{{ target_user.updated_at|date:"M j, Y g:i A" }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>&copy; SCAV {{ HUNT_YEAR }} ¬∑ Crafted by students for students</p>
        </footer>
    </div>

    <script>
    (function () {
        const STORAGE_KEY = "scav-theme";
        const body = document.body;

        const THEME_ICONS = {
            light: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4.5"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="M4.93 4.93l1.42 1.42"></path><path d="M17.66 17.66l1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="M4.93 19.07l1.42-1.42"></path><path d="M17.66 6.34l1.41-1.41"></path></svg>`,
            dark: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79Z"></path></svg>`
        };

        function applyTheme(theme) {
            body.dataset.theme = theme;
            const icon = document.querySelector('[data-theme-icon]');
            if (icon) {
                icon.innerHTML = theme === 'dark' ? THEME_ICONS.dark : THEME_ICONS.light;
            }
        }

        {% if ENABLE_SNOW_OVERLAY %}
        const SNOWFLAKE_COUNT = 80;
        const snowOverlay = document.querySelector('.snow-overlay');
        if (snowOverlay) {
            for (let index = 0; index < SNOWFLAKE_COUNT; index += 1) {
                const flake = document.createElement('span');
                flake.className = 'snowflake';
                const size = (Math.random() * 4) + 2;
                const duration = (Math.random() * 8) + 8;
                const delay = Math.random() * 8;
                const opacity = Math.random() * 0.5 + 0.4;
                const drift = (Math.random() * 2 - 1) * 4;
                const xPosition = Math.random() * 100;
                flake.style.setProperty('--size', `${size}px`);
                flake.style.setProperty('--duration', `${duration}s`);
                flake.style.setProperty('--delay', `${delay}s`);
                flake.style.setProperty('--opacity', opacity.toFixed(2));
                flake.style.setProperty('--drift', `${drift.toFixed(2)}rem`);
                flake.style.setProperty('--x-position', `${xPosition.toFixed(2)}%`);
                snowOverlay.appendChild(flake);
            }
        }
        {% endif %}

        const savedTheme = localStorage.getItem(STORAGE_KEY);
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }

        const toggle = document.getElementById('theme-toggle');
        if (toggle) {
            toggle.addEventListener('click', () => {
                const next = body.dataset.theme === 'dark' ? 'light' : 'dark';
                applyTheme(next);
                localStorage.setItem(STORAGE_KEY, next);
            });
        }

        // Profile menu
        const profileTrigger = document.querySelector('.profile-menu__trigger');
        const profilePopover = document.querySelector('.profile-menu__popover');
        if (profileTrigger && profilePopover) {
            profileTrigger.addEventListener('click', () => {
                const expanded = profileTrigger.getAttribute('aria-expanded') === 'true';
                profileTrigger.setAttribute('aria-expanded', String(!expanded));
                profilePopover.toggleAttribute('data-open');
            });

            document.addEventListener('click', (event) => {
                if (!profilePopover.contains(event.target) && !profileTrigger.contains(event.target)) {
                    profileTrigger.setAttribute('aria-expanded', 'false');
                    profilePopover.removeAttribute('data-open');
                }
            });
        }

        // Toast handling
        const toastContainer = document.querySelector('[data-toast-container]');
        if (toastContainer) {
            const dismissToast = (toast, delay = 0) => {
                if (!toast) return;
                window.setTimeout(() => {
                    toast.classList.add('toast--closing');
                    window.setTimeout(() => {
                        toast.remove();
                        if (!toastContainer.querySelector('[data-toast]')) {
                            toastContainer.hidden = true;
                        }
                    }, 200);
                }, delay);
            };

            toastContainer.querySelectorAll('[data-toast]').forEach((toast, index) => {
                dismissToast(toast, 3500 + index * 500);
                const closeButton = toast.querySelector('[data-toast-close]');
                if (closeButton) {
                    closeButton.addEventListener('click', () => dismissToast(toast));
                }
            });
        }
    })();
    </script>
</body>
</html>
