{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ challenge.title }} - Challenge Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/core.css' %}">
    <link rel="icon" href="{% static 'img/favicon.png' %}" type="image/png">
    <style>
        .detail-layout {
            display: grid;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .detail-section {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .detail-section__header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .detail-section__header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: rgba(37, 99, 235, 0.1);
            transition: background 0.15s;
        }

        .back-link:hover {
            background: rgba(37, 99, 235, 0.2);
        }

        .challenge-header {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .challenge-header h2 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .challenge-meta {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge--type-regular {
            background: rgba(37, 99, 235, 0.15);
            color: var(--accent);
        }

        .badge--type-exclusive {
            background: rgba(239, 68, 68, 0.15);
            color: rgb(185, 28, 28);
        }

        .badge--type-decreasing {
            background: rgba(249, 115, 22, 0.15);
            color: rgb(154, 52, 18);
        }

        .badge--type-dependent {
            background: rgba(16, 185, 129, 0.15);
            color: rgb(5, 122, 85);
        }

        .badge--category {
            background: var(--background);
            color: var(--text-muted);
        }

        .description-box {
            background: var(--background);
            border-radius: 12px;
            padding: 1.25rem;
            color: var(--text);
            line-height: 1.6;
            margin-top: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: var(--background);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-card__value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-card__label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .info-card {
            background: var(--background);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .info-card__title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1rem;
        }

        .info-list {
            list-style: none;
        }

        .info-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .info-list li:last-child {
            border-bottom: none;
        }

        .info-name {
            color: var(--text-muted);
        }

        .info-value {
            color: var(--text);
            font-weight: 500;
        }

        .info-value a {
            color: var(--accent);
            text-decoration: none;
        }

        .info-value a:hover {
            text-decoration: underline;
        }

        .first-blood-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
        }

        .first-blood-card__title {
            font-size: 1rem;
            font-weight: 600;
            color: rgb(185, 28, 28);
            margin-bottom: 0.75rem;
        }

        .first-blood-card__content {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .first-blood-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .first-blood-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .first-blood-value {
            font-size: 1rem;
            color: var(--text);
        }

        .first-blood-value a {
            color: var(--accent);
            text-decoration: none;
        }

        .first-blood-value a:hover {
            text-decoration: underline;
        }

        .solves-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .solves-table th,
        .solves-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .solves-table th {
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .solves-table tr:hover {
            background: var(--background);
        }

        .solves-table a {
            color: var(--accent);
            text-decoration: none;
        }

        .solves-table a:hover {
            text-decoration: underline;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .prereq-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .prereq-item {
            background: var(--background);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .prereq-item a {
            color: var(--accent);
            text-decoration: none;
        }

        .prereq-item a:hover {
            text-decoration: underline;
        }

        .points-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .points-table th,
        .points-table td {
            padding: 0.5rem 1rem;
            text-align: center;
            border: 1px solid var(--border);
        }

        .points-table th {
            background: var(--background);
            font-weight: 600;
            color: var(--text-muted);
        }

        .points-table .current {
            background: rgba(37, 99, 235, 0.1);
            font-weight: 600;
        }

        .admin-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: rgba(37, 99, 235, 0.1);
            transition: background 0.15s;
        }

        .admin-link:hover {
            background: rgba(37, 99, 235, 0.2);
        }
    </style>
</head>
<body class="layout" data-participant-id="{{ participant.pk }}" data-is-admin="{{ participant.is_admin|yesno:'true,false' }}">
    <div class="toast-container" data-toast-container aria-live="polite" aria-atomic="true"{% if not messages %} hidden{% endif %}>
        {% if messages %}
            {% for message in messages %}
                <div class="toast toast--{{ message.tags|default:'info' }}" data-toast>
                    <div class="toast__content">{{ message }}</div>
                    <button type="button" class="toast__close" data-toast-close aria-label="Dismiss notification">&times;</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>
    <div class="page page--challenge">
        {% if ENABLE_SNOW_OVERLAY %}
        <div class="snow-overlay" aria-hidden="true"></div>
        {% endif %}
        <header class="site-nav">
            <div class="site-nav__inner">
            <div class="site-nav__left">
                <div class="logo" aria-hidden="true">
                    <img src="{% static 'img/favicon.png' %}" alt="" class="logo__image">
                </div>
                <div class="site-nav__title">
                    <span class="title-main">Scavenger Hunt</span>
                    <span class="title-sub">{{ HUNT_YEAR }}</span>
                </div>
            </div>
            <div class="site-nav__center">
                <span class="countdown countdown--inactive">Challenge Analytics</span>
            </div>
            <div class="site-nav__right">
                <button id="theme-toggle" class="icon-button" type="button" aria-label="Toggle theme">
                    <span class="icon-button__icon" data-theme-icon aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="4.5"></circle>
                            <path d="M12 2v2"></path>
                            <path d="M12 20v2"></path>
                            <path d="M4.93 4.93l1.42 1.42"></path>
                            <path d="M17.66 17.66l1.41 1.41"></path>
                            <path d="M2 12h2"></path>
                            <path d="M20 12h2"></path>
                            <path d="M4.93 19.07l1.42-1.42"></path>
                            <path d="M17.66 6.34l1.41-1.41"></path>
                        </svg>
                    </span>
                </button>
                <div class="profile-menu">
                    <button class="profile-menu__trigger" type="button" aria-haspopup="true" aria-expanded="false">
                        <span class="profile-menu__avatar">{{ participant.display_name|first|default:participant.ion_username|first|upper }}</span>
                        <span class="profile-menu__label">{{ participant.display_name|default:participant.ion_username }}</span>
                    </button>
                    <div class="profile-menu__popover" role="menu">
                        <p class="profile-menu__hint">Signed in as <strong>{{ participant.display_name|default:participant.ion_username }}</strong></p>
                        <div class="profile-menu__actions">
                            <a href="{% url 'core:challenge' %}" class="profile-menu__button">Challenge Board</a>
                            {% if participant.is_admin or participant.is_scavcomm %}
                                <a href="{% url 'core:analytics' %}" class="profile-menu__button">Analytics</a>
                            {% endif %}
                            {% if participant.is_admin %}
                                <a href="{% url 'admin:index' %}" class="profile-menu__button">Admin dashboard</a>
                            {% endif %}
                            <form method="post" action="{% url 'core:logout' %}" class="profile-menu__logout">
                                {% csrf_token %}
                                <button type="submit" class="profile-menu__button">Log out</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </header>

        <main class="detail-layout">
            <!-- Challenge Header -->
            <section class="detail-section">
                <div class="detail-section__header">
                    <div class="challenge-header">
                        <h2>{{ challenge.title }}</h2>
                        <div class="challenge-meta">
                            <span class="badge badge--type-{{ challenge.challenge_type }}">{{ challenge.get_challenge_type_display }}</span>
                            <span class="badge badge--category">{{ challenge.category.name }}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        {% if participant.is_admin %}
                        <a href="{% url 'admin:core_challenge_change' challenge.pk %}" class="admin-link" target="_blank">Edit in Admin ‚Üó</a>
                        {% endif %}
                        <a href="{% url 'core:analytics' %}" class="back-link">‚Üê Back to Analytics</a>
                    </div>
                </div>

                <div class="description-box">
                    {{ challenge.description }}
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card__value">{{ challenge.base_points }}</div>
                        <div class="stat-card__label">Base Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__value">{{ current_points }}</div>
                        <div class="stat-card__label">Current Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__value">{{ total_solves }}</div>
                        <div class="stat-card__label">Total Solves</div>
                    </div>
                    {% if challenge.is_decreasing %}
                    <div class="stat-card">
                        <div class="stat-card__value">{{ challenge.decay_percent }}%</div>
                        <div class="stat-card__label">Decay Rate</div>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- First Blood -->
            {% if first_blood %}
            <section class="detail-section">
                <div class="first-blood-card">
                    <h3 class="first-blood-card__title">ü©∏ First Blood</h3>
                    <div class="first-blood-card__content">
                        <div class="first-blood-item">
                            <span class="first-blood-label">Team</span>
                            <span class="first-blood-value">Class of {{ first_blood.team_year }}</span>
                        </div>
                        <div class="first-blood-item">
                            <span class="first-blood-label">Solver</span>
                            <span class="first-blood-value">
                                <a href="{% url 'core:user_detail' first_blood.participant.ion_username %}">{{ first_blood.participant.display_name|default:first_blood.participant.ion_username }}</a>
                            </span>
                        </div>
                        <div class="first-blood-item">
                            <span class="first-blood-label">Points Awarded</span>
                            <span class="first-blood-value">{{ first_blood.awarded_points }}</span>
                        </div>
                        <div class="first-blood-item">
                            <span class="first-blood-label">Time</span>
                            <span class="first-blood-value">
                                <a href="{% url 'core:submission_detail' first_blood.id %}">{{ first_blood.created_at|date:"M j, Y, g:i A" }}</a>
                            </span>
                        </div>
                    </div>
                </div>
            </section>
            {% endif %}

            <!-- Challenge Details -->
            <section class="detail-section">
                <h3 class="section-title">Challenge Configuration</h3>
                <div class="info-grid">
                    <div class="info-card">
                        <h4 class="info-card__title">Basic Info</h4>
                        <ul class="info-list">
                            <li>
                                <span class="info-name">Slug</span>
                                <span class="info-value">{{ challenge.slug }}</span>
                            </li>
                            <li>
                                <span class="info-name">Category</span>
                                <span class="info-value">{{ challenge.category.name }}</span>
                            </li>
                            <li>
                                <span class="info-name">Type</span>
                                <span class="info-value">{{ challenge.get_challenge_type_display }}</span>
                            </li>
                            <li>
                                <span class="info-name">Active</span>
                                <span class="info-value">{% if challenge.is_active %}Yes{% else %}No{% endif %}</span>
                            </li>
                            <li>
                                <span class="info-name">Case Sensitive</span>
                                <span class="info-value">{% if challenge.answer_case_sensitive %}Yes{% else %}No{% endif %}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="info-card">
                        <h4 class="info-card__title">Points Configuration</h4>
                        <ul class="info-list">
                            <li>
                                <span class="info-name">Base Points</span>
                                <span class="info-value">{{ challenge.base_points }}</span>
                            </li>
                            {% if challenge.is_decreasing %}
                            <li>
                                <span class="info-name">Decay Percent</span>
                                <span class="info-value">{{ challenge.decay_percent }}%</span>
                            </li>
                            <li>
                                <span class="info-name">Minimum Points</span>
                                <span class="info-value">{{ challenge.minimum_points }}</span>
                            </li>
                            {% endif %}
                            <li>
                                <span class="info-name">Current Points</span>
                                <span class="info-value">{{ current_points }}</span>
                            </li>
                            <li>
                                <span class="info-name">Sort Order</span>
                                <span class="info-value">{{ challenge.sort_order }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Points Progression (for decreasing challenges) -->
            {% if points_progression %}
            <section class="detail-section">
                <h3 class="section-title">Points Progression (Decreasing Challenge)</h3>
                <div style="overflow-x: auto;">
                    <table class="points-table">
                        <thead>
                            <tr>
                                {% for prog in points_progression %}
                                <th>Solve #{{ prog.solve_number }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                {% for prog in points_progression %}
                                <td class="{% if prog.solve_number == total_solves|add:1 %}current{% endif %}">{{ prog.points }} pts</td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Highlighted cell shows points for the next solve.</p>
            </section>
            {% endif %}

            <!-- Prerequisites -->
            {% if prerequisites %}
            <section class="detail-section">
                <h3 class="section-title">Prerequisites ({{ prerequisites|length }})</h3>
                <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.5rem;">These challenges must be solved first:</p>
                <div class="prereq-list">
                    {% for prereq in prerequisites %}
                    <div class="prereq-item">
                        <a href="{% url 'core:challenge_detail' prereq.slug %}">{{ prereq.title }}</a>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Dependent Challenges -->
            {% if dependent_challenges %}
            <section class="detail-section">
                <h3 class="section-title">Unlocks ({{ dependent_challenges|length }})</h3>
                <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.5rem;">Solving this challenge unlocks:</p>
                <div class="prereq-list">
                    {% for dep in dependent_challenges %}
                    <div class="prereq-item">
                        <a href="{% url 'core:challenge_detail' dep.slug %}">{{ dep.title }}</a>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Team Solves Summary -->
            {% if team_stats %}
            <section class="detail-section">
                <h3 class="section-title">Solves by Team</h3>
                <div class="info-grid">
                    {% for team in team_stats %}
                    <div class="info-card">
                        <h4 class="info-card__title">Class of {{ team.team_year }}</h4>
                        <ul class="info-list">
                            <li>
                                <span class="info-name">Solves</span>
                                <span class="info-value">{{ team.solve_count }}</span>
                            </li>
                            <li>
                                <span class="info-name">Points Earned</span>
                                <span class="info-value">{{ team.points }}</span>
                            </li>
                            {% if team.first_solve_time %}
                            <li>
                                <span class="info-name">First Solve</span>
                                <span class="info-value">{{ team.first_solve_time|date:"M j, g:i A" }}</span>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- All Solves -->
            <section class="detail-section">
                <h3 class="section-title">All Solves ({{ total_solves }})</h3>
                {% if solves %}
                <table class="solves-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Team</th>
                            <th>Solved By</th>
                            <th>Points</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for solve in solves %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>Class of {{ solve.team_year }}</td>
                            <td><a href="{% url 'core:user_detail' solve.participant.ion_username %}">{{ solve.participant.display_name|default:solve.participant.ion_username }}</a></td>
                            <td>{{ solve.awarded_points }}</td>
                            <td><a href="{% url 'core:submission_detail' solve.id %}">{{ solve.created_at|date:"M j, g:i A" }}</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p>No one has solved this challenge yet.</p>
                </div>
                {% endif %}
            </section>

            <!-- Answer (Admin only) -->
            {% if participant.is_admin %}
            <section class="detail-section">
                <h3 class="section-title">Answer (Admin View)</h3>
                <div class="description-box" style="font-family: monospace; word-break: break-all;">
                    {{ challenge.answer }}
                </div>
            </section>
            {% endif %}
        </main>

        <footer class="footer">
            <p>&copy; {% now "Y" %} SCAV {{ HUNT_YEAR }} ¬∑ Crafted by students for students</p>
        </footer>
    </div>

    <script>
    (function () {
        const STORAGE_KEY = "scav-theme";
        const body = document.body;

        const THEME_ICONS = {
            light: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4.5"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="M4.93 4.93l1.42 1.42"></path><path d="M17.66 17.66l1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="M4.93 19.07l1.42-1.42"></path><path d="M17.66 6.34l1.41-1.41"></path></svg>`,
            dark: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79Z"></path></svg>`
        };

        function applyTheme(theme) {
            body.dataset.theme = theme;
            const icon = document.querySelector('[data-theme-icon]');
            if (icon) {
                icon.innerHTML = theme === 'dark' ? THEME_ICONS.dark : THEME_ICONS.light;
            }
        }

        {% if ENABLE_SNOW_OVERLAY %}
        const SNOWFLAKE_COUNT = 80;
        const snowOverlay = document.querySelector('.snow-overlay');
        if (snowOverlay) {
            for (let index = 0; index < SNOWFLAKE_COUNT; index += 1) {
                const flake = document.createElement('span');
                flake.className = 'snowflake';
                const size = (Math.random() * 4) + 2;
                const duration = (Math.random() * 8) + 8;
                const delay = Math.random() * 8;
                const opacity = Math.random() * 0.5 + 0.4;
                const drift = (Math.random() * 2 - 1) * 4;
                const xPosition = Math.random() * 100;
                flake.style.setProperty('--size', `${size}px`);
                flake.style.setProperty('--duration', `${duration}s`);
                flake.style.setProperty('--delay', `${delay}s`);
                flake.style.setProperty('--opacity', opacity.toFixed(2));
                flake.style.setProperty('--drift', `${drift.toFixed(2)}rem`);
                flake.style.setProperty('--x-position', `${xPosition.toFixed(2)}%`);
                snowOverlay.appendChild(flake);
            }
        }
        {% endif %}

        const savedTheme = localStorage.getItem(STORAGE_KEY);
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }

        const toggle = document.getElementById('theme-toggle');
        if (toggle) {
            toggle.addEventListener('click', () => {
                const next = body.dataset.theme === 'dark' ? 'light' : 'dark';
                applyTheme(next);
                localStorage.setItem(STORAGE_KEY, next);
            });
        }

        // Profile menu
        const profileTrigger = document.querySelector('.profile-menu__trigger');
        const profilePopover = document.querySelector('.profile-menu__popover');
        if (profileTrigger && profilePopover) {
            profileTrigger.addEventListener('click', () => {
                const expanded = profileTrigger.getAttribute('aria-expanded') === 'true';
                profileTrigger.setAttribute('aria-expanded', String(!expanded));
                profilePopover.toggleAttribute('data-open');
            });

            document.addEventListener('click', (event) => {
                if (!profilePopover.contains(event.target) && !profileTrigger.contains(event.target)) {
                    profileTrigger.setAttribute('aria-expanded', 'false');
                    profilePopover.removeAttribute('data-open');
                }
            });
        }

        // Toast handling
        const toastContainer = document.querySelector('[data-toast-container]');
        if (toastContainer) {
            const dismissToast = (toast, delay = 0) => {
                if (!toast) return;
                window.setTimeout(() => {
                    toast.classList.add('toast--closing');
                    window.setTimeout(() => {
                        toast.remove();
                        if (!toastContainer.querySelector('[data-toast]')) {
                            toastContainer.hidden = true;
                        }
                    }, 200);
                }, delay);
            };

            toastContainer.querySelectorAll('[data-toast]').forEach((toast, index) => {
                dismissToast(toast, 3500 + index * 500);
                const closeButton = toast.querySelector('[data-toast-close]');
                if (closeButton) {
                    closeButton.addEventListener('click', () => dismissToast(toast));
                }
            });
        }
    })();
    </script>
</body>
</html>
