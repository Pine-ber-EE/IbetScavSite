{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Analytics Dashboard - Scavenger Hunt</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/core.css' %}">
    <link rel="icon" href="{% static 'img/favicon.png' %}" type="image/png">
    <style>
        .analytics-layout {
            display: grid;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .analytics-section {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .analytics-section__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .analytics-section__header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .analytics-section__header .hint {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: var(--background);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-card__value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-card__label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .submissions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .submissions-table th,
        .submissions-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .submissions-table th {
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .submissions-table tr:hover {
            background: var(--background);
        }

        .submissions-table a {
            color: var(--accent);
            text-decoration: none;
        }

        .submissions-table a:hover {
            text-decoration: underline;
        }

        .submissions-table td.answer {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .first-blood-badge {
            background: rgba(239, 68, 68, 0.15);
            color: rgb(185, 28, 28);
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .class-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .class-card {
            background: var(--background);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--border);
        }

        .class-card__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .class-card__title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .class-card__score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .class-card__stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .class-card__stat {
            text-align: center;
        }

        .class-card__stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .class-card__stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .class-card__section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 1rem 0 0.5rem;
        }

        .contributor-list {
            list-style: none;
        }

        .contributor-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .contributor-list li:last-child {
            border-bottom: none;
        }

        .contributor-name {
            color: var(--text);
        }

        .contributor-name a {
            color: var(--accent);
            text-decoration: none;
        }

        .contributor-name a:hover {
            text-decoration: underline;
        }

        .contributor-stats {
            color: var(--text-muted);
        }

        .activity-list {
            list-style: none;
        }

        .activity-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .activity-list li:last-child {
            border-bottom: none;
        }

        .activity-challenge {
            font-weight: 500;
            color: var(--text);
        }

        .activity-challenge a {
            color: var(--accent);
            text-decoration: none;
        }

        .activity-challenge a:hover {
            text-decoration: underline;
        }

        .activity-meta {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .activity-meta a {
            color: var(--accent);
            text-decoration: none;
        }

        .activity-meta a:hover {
            text-decoration: underline;
        }

        .switch-class-form {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .switch-class-form select {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-size: 0.875rem;
        }

        .switch-class-form button {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .switch-class-form button:hover {
            opacity: 0.9;
        }

        .current-view-badge {
            background: rgba(37, 99, 235, 0.15);
            color: var(--accent);
            padding: 0.3rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
            margin: 0 -1.5rem;
            padding: 0 1.5rem;
        }

        .challenge-stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .challenge-stats-table th,
        .challenge-stats-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .challenge-stats-table th {
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .challenge-stats-table tr:hover {
            background: var(--background);
        }

        .challenge-stats-table a {
            color: var(--accent);
            text-decoration: none;
        }

        .challenge-stats-table a:hover {
            text-decoration: underline;
        }

        .unsolved-badge {
            background: rgba(249, 115, 22, 0.15);
            color: rgb(154, 52, 18);
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s;
        }

        .tab-button:hover {
            color: var(--text);
            background: var(--background);
        }

        .tab-button.active {
            color: var(--accent);
            background: rgba(37, 99, 235, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state__icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .analytics-layout {
                padding: 1rem;
            }

            .class-stats-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body class="layout" data-participant-id="{{ participant.pk }}" data-is-admin="{{ participant.is_admin|yesno:'true,false' }}">
    <div class="toast-container" data-toast-container aria-live="polite" aria-atomic="true"{% if not messages %} hidden{% endif %}>
        {% if messages %}
            {% for message in messages %}
                <div class="toast toast--{{ message.tags|default:'info' }}" data-toast>
                    <div class="toast__content">{{ message }}</div>
                    <button type="button" class="toast__close" data-toast-close aria-label="Dismiss notification">&times;</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>
    <div class="page page--challenge">
        {% if ENABLE_SNOW_OVERLAY %}
        <div class="snow-overlay" aria-hidden="true"></div>
        {% endif %}
        <header class="site-nav">
            <div class="site-nav__inner">
            <div class="site-nav__left">
                <div class="logo" aria-hidden="true">
                    <img src="{% static 'img/favicon.png' %}" alt="" class="logo__image">
                </div>
                <div class="site-nav__title">
                    <span class="title-main">Scavenger Hunt</span>
                    <span class="title-sub">{{ HUNT_YEAR }}</span>
                </div>
            </div>
            <div class="site-nav__center">
                <span class="countdown countdown--inactive">Analytics Dashboard</span>
            </div>
            <div class="site-nav__right">
                <button id="theme-toggle" class="icon-button" type="button" aria-label="Toggle theme">
                    <span class="icon-button__icon" data-theme-icon aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="4.5"></circle>
                            <path d="M12 2v2"></path>
                            <path d="M12 20v2"></path>
                            <path d="M4.93 4.93l1.42 1.42"></path>
                            <path d="M17.66 17.66l1.41 1.41"></path>
                            <path d="M2 12h2"></path>
                            <path d="M20 12h2"></path>
                            <path d="M4.93 19.07l1.42-1.42"></path>
                            <path d="M17.66 6.34l1.41-1.41"></path>
                        </svg>
                    </span>
                </button>
                <div class="profile-menu">
                    <button class="profile-menu__trigger" type="button" aria-haspopup="true" aria-expanded="false">
                        <span class="profile-menu__avatar">{{ participant.display_name|first|default:participant.ion_username|first|upper }}</span>
                        <span class="profile-menu__label">{{ participant.display_name|default:participant.ion_username }}</span>
                    </button>
                    <div class="profile-menu__popover" role="menu">
                        <p class="profile-menu__hint">Signed in as <strong>{{ participant.display_name|default:participant.ion_username }}</strong></p>
                        <div class="profile-menu__actions">
                            <a href="{% url 'core:challenge' %}" class="profile-menu__button">Challenge Board</a>
                            {% if participant.is_admin or participant.is_scavcomm %}
                                <a href="{% url 'core:analytics' %}" class="profile-menu__button">Analytics</a>
                            {% endif %}
                            {% if participant.is_admin %}
                                <a href="{% url 'admin:index' %}" class="profile-menu__button">Admin dashboard</a>
                            {% endif %}
                            <form method="post" action="{% url 'core:logout' %}" class="profile-menu__logout">
                                {% csrf_token %}
                                <button type="submit" class="profile-menu__button">Log out</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </header>

        <main class="analytics-layout">
            <!-- Overview Stats -->
            <section class="analytics-section">
                <div class="analytics-section__header">
                    <div>
                        <h2>Hunt Overview</h2>
                        <span class="hint">
                            {% if hunt_starts_at %}Starts: {{ hunt_starts_at }}{% endif %}
                            {% if hunt_ends_at %} Â· Ends: {{ hunt_ends_at }}{% endif %}
                        </span>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card__value">{{ overall_stats.total_participants }}</div>
                        <div class="stat-card__label">Total Participants</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__value">{{ overall_stats.total_challenges }}</div>
                        <div class="stat-card__label">Total Challenges</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__value">{{ overall_stats.solved_challenges }}</div>
                        <div class="stat-card__label">Solved Challenges</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__value">{{ overall_stats.unsolved_challenges }}</div>
                        <div class="stat-card__label">Unsolved Challenges</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__value">{{ overall_stats.total_submissions }}</div>
                        <div class="stat-card__label">Total Submissions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__value">{{ overall_stats.total_points_awarded }}</div>
                        <div class="stat-card__label">Points Awarded</div>
                    </div>
                </div>
            </section>

            <!-- Admin View Switcher -->
            <section class="analytics-section">
                <div class="analytics-section__header">
                    <div>
                        <h2>Admin View Switcher</h2>
                        <span class="hint">Switch your graduation year to view the hunt from a different class's perspective for troubleshooting.</span>
                    </div>
                    {% if admin_view_as_class %}
                        <span class="current-view-badge">Currently viewing as Class of {{ admin_view_as_class }}</span>
                    {% endif %}
                </div>
                <form method="post" action="{% url 'core:switch_class' %}" class="switch-class-form">
                    {% csrf_token %}
                    <select name="class_year">
                        <option value="">Select a class...</option>
                        {% for year in team_years %}
                            <option value="{{ year }}" {% if admin_view_as_class == year %}selected{% endif %}>Class of {{ year }}</option>
                        {% endfor %}
                        {% if admin_view_as_class %}
                            <option value="reset">â€” Reset to original â€”</option>
                        {% endif %}
                    </select>
                    <button type="submit">Switch View</button>
                </form>
            </section>

            <!-- Tabs for different sections -->
            <section class="analytics-section">
                <div class="tabs">
                    <button class="tab-button active" data-tab="submissions">Submission Logs</button>
                    <button class="tab-button" data-tab="classes">Class Statistics</button>
                    <button class="tab-button" data-tab="challenges">Challenge Stats</button>
                    <button class="tab-button" data-tab="leaderboard">Leaderboard</button>
                </div>

                <!-- Submission Logs Tab -->
                <div class="tab-content active" id="submissions-tab">
                    {% if submission_logs %}
                        <div class="table-container">
                            <table class="submissions-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Challenge</th>
                                        <th>Category</th>
                                        <th>Submitted By</th>
                                        <th>Class</th>
                                        <th>Answer</th>
                                        <th>Points</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in submission_logs %}
                                        <tr>
                                            <td><a href="{% url 'core:submission_detail' log.id %}">{{ log.created_at|date:"M j, g:i A" }}</a></td>
                                            <td>
                                                <a href="{% url 'core:challenge_detail' log.challenge_slug %}">{{ log.challenge_title }}</a>
                                                {% if log.is_first_blood %}<span class="first-blood-badge">First Blood</span>{% endif %}
                                            </td>
                                            <td>{{ log.category_name }}</td>
                                            <td title="{{ log.participant_username }}"><a href="{% url 'core:user_detail' log.participant_username %}">{{ log.participant_name }}</a></td>
                                            <td>{{ log.team_year }}</td>
                                            <td class="answer" title="{{ log.submitted_answer }}">{{ log.submitted_answer }}</td>
                                            <td>{{ log.awarded_points }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state__icon">ðŸ“‹</div>
                            <p>No submissions yet.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Class Statistics Tab -->
                <div class="tab-content" id="classes-tab">
                    <div class="class-stats-grid">
                        {% for cls in class_stats %}
                            <article class="class-card">
                                <header class="class-card__header">
                                    <span class="class-card__title">{{ cls.label }}</span>
                                    <span class="class-card__score">{{ cls.total_points }} pts</span>
                                </header>
                                <div class="class-card__stats">
                                    <div class="class-card__stat">
                                        <div class="class-card__stat-value">{{ cls.total_members }}</div>
                                        <div class="class-card__stat-label">Members</div>
                                    </div>
                                    <div class="class-card__stat">
                                        <div class="class-card__stat-value">{{ cls.total_solves }}</div>
                                        <div class="class-card__stat-label">Solves</div>
                                    </div>
                                    <div class="class-card__stat">
                                        <div class="class-card__stat-value">{% if cls.total_solves > 0 %}{{ cls.total_points|floatformat:0 }}{% else %}0{% endif %}</div>
                                        <div class="class-card__stat-label">Avg Pts/Solve</div>
                                    </div>
                                </div>

                                <h4 class="class-card__section-title">Top Contributors</h4>
                                {% if cls.top_contributors %}
                                    <ul class="contributor-list">
                                        {% for contrib in cls.top_contributors %}
                                            <li>
                                                <span class="contributor-name" title="{{ contrib.username }}"><a href="{% url 'core:user_detail' contrib.username %}">{{ contrib.name }}</a></span>
                                                <span class="contributor-stats">{{ contrib.points }} pts Â· {{ contrib.solves }} solve{{ contrib.solves|pluralize }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p style="color: var(--text-muted); font-size: 0.875rem;">No contributors yet.</p>
                                {% endif %}

                                <h4 class="class-card__section-title">Recent Activity</h4>
                                {% if cls.recent_activity %}
                                    <ul class="activity-list">
                                        {% for activity in cls.recent_activity %}
                                            <li>
                                                <div class="activity-challenge"><a href="{% url 'core:challenge_detail' activity.challenge_slug %}">{{ activity.challenge }}</a></div>
                                                <div class="activity-meta"><a href="{% url 'core:user_detail' activity.solver_username %}">{{ activity.solver }}</a> Â· {{ activity.points }} pts Â· {{ activity.time|date:"M j, g:i A" }}</div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p style="color: var(--text-muted); font-size: 0.875rem;">No activity yet.</p>
                                {% endif %}
                            </article>
                        {% endfor %}
                    </div>
                </div>

                <!-- Challenge Stats Tab -->
                <div class="tab-content" id="challenges-tab">
                    {% if challenge_stats %}
                        <div class="table-container">
                            <table class="challenge-stats-table">
                                <thead>
                                    <tr>
                                        <th>Challenge</th>
                                        <th>Category</th>
                                        <th>Type</th>
                                        <th>Base Points</th>
                                        <th>Solves</th>
                                        <th>First Blood</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for challenge in challenge_stats %}
                                        <tr>
                                            <td><a href="{% url 'core:challenge_detail' challenge.slug %}">{{ challenge.title }}</a></td>
                                            <td>{{ challenge.category }}</td>
                                            <td>{{ challenge.type }}</td>
                                            <td>{{ challenge.base_points }}</td>
                                            <td>
                                                {{ challenge.solve_count }}
                                                {% if challenge.solve_count == 0 %}<span class="unsolved-badge">Unsolved</span>{% endif %}
                                            </td>
                                            <td>
                                                {% if challenge.first_blood_team %}
                                                    {{ challenge.first_blood_team }} (<a href="{% url 'core:user_detail' challenge.first_blood_username %}">{{ challenge.first_blood_solver }}</a>)
                                                    <br><small style="color: var(--text-muted);">{{ challenge.first_blood_time|date:"M j, g:i A" }}</small>
                                                {% else %}
                                                    â€”
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state__icon">ðŸŽ¯</div>
                            <p>No challenges available.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Leaderboard Tab -->
                <div class="tab-content" id="leaderboard-tab">
                    <div class="leaderboard-grid" style="max-width: 600px;">
                        {% for entry in leaderboard %}
                            <article class="leaderboard-card{% if entry.is_user_team %} leaderboard-card--highlight{% endif %}">
                                <header>
                                    <span class="leaderboard-rank">#{{ entry.rank }}</span>
                                    <span class="leaderboard-team">{{ entry.label }}</span>
                                </header>
                                <div class="leaderboard-score">{{ entry.score }}</div>
                                <footer>
                                    <span class="leaderboard-meta">Members: {{ entry.member_count }}</span>
                                    {% if entry.is_user_team %}<span class="leaderboard-meta leaderboard-meta--badge">Your team</span>{% endif %}
                                </footer>
                            </article>
                        {% endfor %}
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>&copy; SCAV {{ HUNT_YEAR }} Â· Crafted by students for students</p>
        </footer>
    </div>

    <script>
    (function () {
        const STORAGE_KEY = "scav-theme";
        const body = document.body;

        const THEME_ICONS = {
            light: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4.5"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="M4.93 4.93l1.42 1.42"></path><path d="M17.66 17.66l1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="M4.93 19.07l1.42-1.42"></path><path d="M17.66 6.34l1.41-1.41"></path></svg>`,
            dark: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79Z"></path></svg>`
        };

        function applyTheme(theme) {
            body.dataset.theme = theme;
            const icon = document.querySelector('[data-theme-icon]');
            if (icon) {
                icon.innerHTML = theme === 'dark' ? THEME_ICONS.dark : THEME_ICONS.light;
            }
        }

        {% if ENABLE_SNOW_OVERLAY %}
        const SNOWFLAKE_COUNT = 80;
        const snowOverlay = document.querySelector('.snow-overlay');
        if (snowOverlay) {
            for (let index = 0; index < SNOWFLAKE_COUNT; index += 1) {
                const flake = document.createElement('span');
                flake.className = 'snowflake';
                const size = (Math.random() * 4) + 2;
                const duration = (Math.random() * 8) + 8;
                const delay = Math.random() * 8;
                const opacity = Math.random() * 0.5 + 0.4;
                const drift = (Math.random() * 2 - 1) * 4;
                const xPosition = Math.random() * 100;
                flake.style.setProperty('--size', `${size}px`);
                flake.style.setProperty('--duration', `${duration}s`);
                flake.style.setProperty('--delay', `${delay}s`);
                flake.style.setProperty('--opacity', opacity.toFixed(2));
                flake.style.setProperty('--drift', `${drift.toFixed(2)}rem`);
                flake.style.setProperty('--x-position', `${xPosition.toFixed(2)}%`);
                snowOverlay.appendChild(flake);
            }
        }
        {% endif %}

        const savedTheme = localStorage.getItem(STORAGE_KEY);
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }

        const toggle = document.getElementById('theme-toggle');
        if (toggle) {
            toggle.addEventListener('click', () => {
                const next = body.dataset.theme === 'dark' ? 'light' : 'dark';
                applyTheme(next);
                localStorage.setItem(STORAGE_KEY, next);
            });
        }

        // Profile menu
        const profileTrigger = document.querySelector('.profile-menu__trigger');
        const profilePopover = document.querySelector('.profile-menu__popover');
        if (profileTrigger && profilePopover) {
            profileTrigger.addEventListener('click', () => {
                const expanded = profileTrigger.getAttribute('aria-expanded') === 'true';
                profileTrigger.setAttribute('aria-expanded', String(!expanded));
                profilePopover.toggleAttribute('data-open');
            });

            document.addEventListener('click', (event) => {
                if (!profilePopover.contains(event.target) && !profileTrigger.contains(event.target)) {
                    profileTrigger.setAttribute('aria-expanded', 'false');
                    profilePopover.removeAttribute('data-open');
                }
            });
        }

        // Tabs functionality
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;

                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                button.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // Toast handling
        const toastContainer = document.querySelector('[data-toast-container]');
        if (toastContainer) {
            const dismissToast = (toast, delay = 0) => {
                if (!toast) {
                    return;
                }
                window.setTimeout(() => {
                    toast.classList.add('toast--closing');
                    window.setTimeout(() => {
                        toast.remove();
                        if (!toastContainer.querySelector('[data-toast]')) {
                            toastContainer.hidden = true;
                        }
                    }, 200);
                }, delay);
            };

            toastContainer.querySelectorAll('[data-toast]').forEach((toast, index) => {
                dismissToast(toast, 3500 + index * 500);
                const closeButton = toast.querySelector('[data-toast-close]');
                if (closeButton) {
                    closeButton.addEventListener('click', () => dismissToast(toast));
                }
            });
        }
    })();
    </script>
</body>
</html>
